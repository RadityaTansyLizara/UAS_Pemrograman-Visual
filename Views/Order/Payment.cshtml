@model BabyShopWeb2.Models.Order
@{
    ViewData["Title"] = $"Pembayaran - {Model.OrderNumber}";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="fw-bold text-pink mb-2">
                    <i class="fas fa-credit-card me-2"></i>Pembayaran
                </h1>
                <p class="lead text-muted">Silakan pilih metode pembayaran untuk menyelesaikan pesanan Anda</p>
            </div>

            <div class="row">
                <!-- Order Summary -->
                <div class="col-lg-5 mb-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-receipt me-2"></i>Ringkasan Pesanan
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <small class="text-muted">No. Pesanan</small>
                                <div class="fw-bold text-pink">@Model.OrderNumber</div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">Tanggal</small>
                                <div>@Model.OrderDate.ToString("dd MMMM yyyy, HH:mm")</div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">Pelanggan</small>
                                <div>@Model.CustomerName</div>
                                <div class="small text-muted">@Model.CustomerPhone</div>
                            </div>

                            <hr>

                            <!-- Items -->
                            <div class="mb-3">
                                <small class="text-muted">Item Pesanan (@Model.OrderItems.Count item)</small>
                                @foreach (var item in Model.OrderItems.Take(3))
                                {
                                    <div class="d-flex justify-content-between align-items-center py-1">
                                        <div class="small">
                                            @item.Product.Name
                                            <span class="text-muted">x@item.Quantity</span>
                                        </div>
                                        <div class="small fw-medium">Rp @item.Subtotal.ToString("N0")</div>
                                    </div>
                                }
                                @if (Model.OrderItems.Count > 3)
                                {
                                    <div class="small text-muted">... dan @(Model.OrderItems.Count - 3) item lainnya</div>
                                }
                            </div>

                            <hr>

                            <!-- Total -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Subtotal:</span>
                                <span>Rp @Model.SubTotal.ToString("N0")</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Ongkos Kirim:</span>
                                <span class="text-success fw-bold">GRATIS</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center border-top pt-3">
                                <span class="fw-bold fs-5">Total Pembayaran:</span>
                                <span class="fw-bold text-pink fs-4">Rp @Model.TotalAmount.ToString("N0")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="col-lg-7">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-pink text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-wallet me-2"></i>Pilih Metode Pembayaran
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Cash Payment -->
                            <div class="payment-method" data-method="cash">
                                <div class="p-4 border-bottom">
                                    <div class="d-flex align-items-center">
                                        <div class="payment-icon me-3">
                                            <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-1">Bayar Tunai (Cash)</h6>
                                            <p class="text-muted small mb-0">Bayar langsung saat pengambilan barang</p>
                                        </div>
                                        <div>
                                            <button class="btn btn-outline-success select-payment" data-method="Cash">
                                                <i class="fas fa-check me-1"></i>Pilih
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- E-Wallet Section -->
                            <div class="p-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-mobile-alt me-2 text-pink"></i>E-Wallet / Mobile Banking
                                </h6>
                                <p class="text-muted small mb-4">Scan QR Code di bawah untuk membayar dengan aplikasi favorit Anda</p>

                                <!-- QR Code -->
                                <div class="text-center mb-4">
                                    <div class="qr-code-container">
                                        <div id="qrcode" class="d-inline-block p-3 bg-white border rounded shadow-sm"></div>
                                        <div class="mt-2">
                                            <small class="text-muted">Scan dengan aplikasi DANA, GoPay, atau OVO</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- E-Wallet Options -->
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="ewallet-option" data-wallet="dana">
                                            <div class="card h-100 border-2 ewallet-card">
                                                <div class="card-body text-center p-3">
                                                    <div class="ewallet-logo mb-2">
                                                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                            <span class="fw-bold">DANA</span>
                                                        </div>
                                                    </div>
                                                    <h6 class="fw-bold mb-1">DANA</h6>
                                                    <button class="btn btn-sm btn-outline-primary select-payment w-100" data-method="DANA">
                                                        <i class="fas fa-qrcode me-1"></i>Bayar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="ewallet-option" data-wallet="gopay">
                                            <div class="card h-100 border-2 ewallet-card">
                                                <div class="card-body text-center p-3">
                                                    <div class="ewallet-logo mb-2">
                                                        <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                            <span class="fw-bold">GP</span>
                                                        </div>
                                                    </div>
                                                    <h6 class="fw-bold mb-1">GoPay</h6>
                                                    <button class="btn btn-sm btn-outline-success select-payment w-100" data-method="GoPay">
                                                        <i class="fas fa-qrcode me-1"></i>Bayar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="ewallet-option" data-wallet="ovo">
                                            <div class="card h-100 border-2 ewallet-card">
                                                <div class="card-body text-center p-3">
                                                    <div class="ewallet-logo mb-2">
                                                        <div class="bg-warning text-dark rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                            <span class="fw-bold">OVO</span>
                                                        </div>
                                                    </div>
                                                    <h6 class="fw-bold mb-1">OVO</h6>
                                                    <button class="btn btn-sm btn-outline-warning select-payment w-100" data-method="OVO">
                                                        <i class="fas fa-qrcode me-1"></i>Bayar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Instructions -->
                                <div class="alert alert-info mt-4">
                                    <h6 class="fw-bold mb-2">
                                        <i class="fas fa-info-circle me-2"></i>Cara Pembayaran E-Wallet:
                                    </h6>
                                    <ol class="mb-0 small">
                                        <li>Pilih metode pembayaran (DANA/GoPay/OVO)</li>
                                        <li>Scan QR Code dengan aplikasi yang dipilih</li>
                                        <li>Konfirmasi pembayaran di aplikasi</li>
                                        <li>Klik "Konfirmasi Pembayaran" setelah berhasil transfer</li>
                                    </ol>
                                </div>
                                
                                <!-- Dynamic E-Wallet Instructions -->
                                <div id="ewallet-instructions" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm Payment Button -->
                    <div class="text-center mt-4">
                        <form asp-action="ConfirmPayment" method="post" id="paymentForm">
                            <input type="hidden" name="orderId" value="@Model.Id" />
                            <input type="hidden" name="paymentMethod" id="selectedMethod" value="" />
                            
                            <button type="submit" class="btn btn-pink btn-lg px-5" id="confirmBtn" disabled>
                                <i class="fas fa-check-circle me-2"></i>Konfirmasi Pembayaran
                            </button>
                        </form>
                        
                        <div class="mt-3">
                            <a asp-controller="Product" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Kembali Belanja
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.payment-method {
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method:hover {
    background-color: #f8f9fa;
}

.ewallet-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.ewallet-card:hover {
    border-color: #ff6b9d !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.ewallet-card.selected {
    border-color: #ff6b9d !important;
    background-color: #fff5f8;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(255, 107, 157, 0.2);
}

.qr-code-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 20px;
    display: inline-block;
    transition: all 0.3s ease;
}

.qr-code-container.highlight {
    background: linear-gradient(135deg, #fff5f8 0%, #ffe8f0 100%);
    border: 2px solid #ff6b9d;
    box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
}

#qrcode {
    background: white;
    border-radius: 10px;
}

.payment-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 10px;
}

.payment-success {
    animation: successPulse 0.6s ease-out;
}

@@keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.cash-selected {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 2px solid #28a745;
    animation: successPulse 0.6s ease-out;
}
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const confirmBtn = document.getElementById('confirmBtn');
            const selectedMethodInput = document.getElementById('selectedMethod');
            const paymentButtons = document.querySelectorAll('.select-payment');
            const ewalletCards = document.querySelectorAll('.ewallet-card');
            
            // Generate QR Code
            const qrData = `BabyShop3Berlian|Order:@Model.OrderNumber|Amount:@Model.TotalAmount|Customer:@Model.CustomerName`;
            QRCode.toCanvas(document.getElementById('qrcode'), qrData, {
                width: 200,
                height: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            });
            
            // Handle payment method selection
            paymentButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    
                    console.log('Payment method selected:', method);
                    
                    // Remove previous selections and highlights
                    ewalletCards.forEach(card => card.classList.remove('selected'));
                    document.querySelector('.qr-code-container')?.classList.remove('highlight');
                    document.querySelector('.payment-method')?.classList.remove('cash-selected');
                    document.getElementById('ewallet-instructions').style.display = 'none';
                    
                    paymentButtons.forEach(btn => {
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-success', 'btn-outline-primary', 'btn-outline-warning');
                        btn.innerHTML = '<i class="fas fa-qrcode me-1"></i>Bayar';
                    });
                    
                    // Mark current selection
                    this.classList.remove('btn-outline-success', 'btn-outline-primary', 'btn-outline-warning');
                    this.classList.add('btn-success');
                    this.innerHTML = '<i class="fas fa-check me-1"></i>Dipilih';
                    
                    // If ewallet, highlight the card
                    const parentCard = this.closest('.ewallet-option');
                    if (parentCard) {
                        parentCard.querySelector('.ewallet-card').classList.add('selected');
                    }
                    
                    // Set selected method
                    selectedMethodInput.value = method;
                    
                    // Handle different payment methods
                    if (method === 'Cash') {
                        // For Cash payment, show confirmation and auto-submit
                        const cashMethod = document.querySelector('.payment-method');
                        cashMethod.classList.add('cash-selected');
                        
                        setTimeout(() => {
                            if (confirm('Konfirmasi pembayaran tunai?\n\nPembayaran akan dilakukan saat pengambilan barang.')) {
                                document.getElementById('paymentForm').submit();
                            } else {
                                // Reset if cancelled
                                cashMethod.classList.remove('cash-selected');
                                selectedMethodInput.value = '';
                            }
                        }, 300);
                    } else {
                        // For E-Wallet, highlight QR code and enable manual confirm
                        const qrContainer = document.querySelector('.qr-code-container');
                        qrContainer.classList.add('highlight');
                        
                        confirmBtn.disabled = false;
                        confirmBtn.classList.remove('btn-secondary');
                        confirmBtn.classList.add('btn-pink');
                        confirmBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Konfirmasi Pembayaran ' + method;
                        
                        // Show specific instructions for selected e-wallet
                        showEwalletInstructions(method);
                        
                        // Scroll to QR code
                        qrContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
            
            // Form validation
            document.getElementById('paymentForm').addEventListener('submit', function(e) {
                if (!selectedMethodInput.value) {
                    e.preventDefault();
                    alert('Silakan pilih metode pembayaran terlebih dahulu');
                    return false;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memproses...';
            });
            
            // Function to show e-wallet specific instructions
            function showEwalletInstructions(method) {
                const instructionDiv = document.getElementById('ewallet-instructions');
                let instructions = '';
                
                switch(method) {
                    case 'DANA':
                        instructions = `
                            <div class="alert alert-primary">
                                <h6><i class="fas fa-mobile-alt me-2"></i>Cara Bayar dengan DANA:</h6>
                                <ol class="mb-0 small">
                                    <li>Buka aplikasi DANA di smartphone Anda</li>
                                    <li>Pilih menu "Scan QR" atau "Bayar"</li>
                                    <li>Scan QR Code di atas</li>
                                    <li>Konfirmasi pembayaran Rp @Model.TotalAmount.ToString("N0")</li>
                                    <li>Setelah berhasil, klik "Konfirmasi Pembayaran DANA"</li>
                                </ol>
                            </div>
                        `;
                        break;
                    case 'GoPay':
                        instructions = `
                            <div class="alert alert-success">
                                <h6><i class="fas fa-mobile-alt me-2"></i>Cara Bayar dengan GoPay:</h6>
                                <ol class="mb-0 small">
                                    <li>Buka aplikasi Gojek di smartphone Anda</li>
                                    <li>Pilih "GoPay" lalu "Scan QR"</li>
                                    <li>Scan QR Code di atas</li>
                                    <li>Konfirmasi pembayaran Rp @Model.TotalAmount.ToString("N0")</li>
                                    <li>Setelah berhasil, klik "Konfirmasi Pembayaran GoPay"</li>
                                </ol>
                            </div>
                        `;
                        break;
                    case 'OVO':
                        instructions = `
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-mobile-alt me-2"></i>Cara Bayar dengan OVO:</h6>
                                <ol class="mb-0 small">
                                    <li>Buka aplikasi OVO di smartphone Anda</li>
                                    <li>Pilih "Scan" di menu utama</li>
                                    <li>Scan QR Code di atas</li>
                                    <li>Konfirmasi pembayaran Rp @Model.TotalAmount.ToString("N0")</li>
                                    <li>Setelah berhasil, klik "Konfirmasi Pembayaran OVO"</li>
                                </ol>
                            </div>
                        `;
                        break;
                }
                
                instructionDiv.innerHTML = instructions;
                instructionDiv.style.display = 'block';
            }
        });
    </script>
}